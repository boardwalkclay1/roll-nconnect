<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Marketplace â€” Roll â€™n Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="rc_global.css">
</head>
<body>

<div class="stars1"></div><div class="stars2"></div><div class="stars3"></div>

<div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
<div class="sidebar" id="sidebar">
  <h2>Menu</h2>
  <a href="index.html">Home</a>
  <a href="find-spots.html">Find Spots</a>
  <a href="events.html">Events</a>
  <a href="marketplace.html">Marketplace</a>
  <a href="chatrooms.html">Messages</a>
  <a href="profile.html">Your Profile</a>
</div>

<div class="wrapper" style="padding:24px;">
  <div class="glass" style="padding:24px;margin-bottom:16px;">
    <div class="flex-between flex-wrap gap-md">
      <div>
        <h1 class="section-title">Marketplace</h1>
        <p style="opacity:0.8;">Listings from skaters, crews, and hosts. Message directly, meet up in real life.</p>
      </div>
      <div>
        <a href="marketplace-create.html" class="btn-primary">+ Create Listing</a>
        <a href="marketplace-my.html" class="btn-secondary" style="margin-left:8px;">My Listings</a>
        <a href="marketplace-saved.html" class="btn-secondary" style="margin-left:8px;">Saved</a>
      </div>
    </div>

    <div class="flex-between flex-wrap gap-md" style="margin-top:16px;">
      <input id="marketSearchInput" class="glass-input" placeholder="Search listingsâ€¦">
      <select id="marketSortSelect" class="glass-input" style="max-width:180px;">
        <option value="featured">Featured</option>
        <option value="price_low">Price: Low â†’ High</option>
        <option value="price_high">Price: High â†’ Low</option>
        <option value="newest">Newest</option>
      </select>
    </div>

    <div class="market-filters" id="marketFilterBar" style="margin-top:16px;">
      <button class="market-chip" data-filter="gear">ğŸ›¼ Gear</button>
      <button class="market-chip" data-filter="lesson">ğŸ“š Lessons</button>
      <button class="market-chip" data-filter="session">ğŸ”¥ Sessions</button>
      <button class="market-chip" data-filter="event">ğŸŸ Events</button>
      <button class="market-chip" data-filter="digital">ğŸ’¾ Digital</button>
      <button class="market-chip" data-filter="spot_based">ğŸ“ Spot-based</button>
    </div>
  </div>

  <div class="glass" style="padding:24px;">
    <div id="marketGrid" class="market-grid"></div>
  </div>
</div>

<script src="rc_core.js"></script>
<script src="js/rc_market_core.js"></script>
<script>
  document.getElementById("hamburger").onclick = () => {
    document.getElementById("hamburger").classList.toggle("active");
    document.getElementById("sidebar").classList.toggle("open");
  };

  document.addEventListener("DOMContentLoaded", () => {
    const core = window.RC_MARKET_CORE;
    const els = {
      grid: document.getElementById("marketGrid"),
      searchInput: document.getElementById("marketSearchInput"),
      sortSelect: document.getElementById("marketSortSelect"),
      filterBar: document.getElementById("marketFilterBar"),
    };

    let activeFilters = new Set();
    let filtered = [];

    function applyFilters() {
      const all = core.getListings();
      const q = (els.searchInput.value || "").toLowerCase().trim();
      const sort = els.sortSelect.value;
      const hasFilters = activeFilters.size > 0;

      filtered = all.filter(item => {
        const matchesSearch =
          !q ||
          item.title.toLowerCase().includes(q) ||
          (item.description || "").toLowerCase().includes(q) ||
          (item.tags || []).some(t => t.toLowerCase().includes(q));

        const matchesFilter =
          !hasFilters ||
          activeFilters.has(item.category) ||
          (activeFilters.has("spot_based") && !!item.spotId);

        return matchesSearch && matchesFilter;
      });

      filtered.sort((a, b) => {
        if (sort === "price_low") return (a.price || 0) - (b.price || 0);
        if (sort === "price_high") return (b.price || 0) - (a.price || 0);
        if (sort === "newest") return (b.createdAt || 0) - (a.createdAt || 0);
        return (b.createdAt || 0) - (a.createdAt || 0);
      });

      render();
    }

    function render() {
      if (!filtered.length) {
        els.grid.innerHTML = "<p style='opacity:0.7;'>No listings found.</p>";
        return;
      }

      els.grid.innerHTML = filtered.map(item => `
        <div class="market-card" onclick="window.location.href='marketplace-item.html?id=${item.id}'">
          <div class="market-card-photo">
            ${renderThumb(item)}
          </div>
          <div style="margin-top:8px;">
            <strong>${item.title}</strong><br>
            <span style="opacity:0.8;font-size:13px;">${item.category}${item.spotName ? " â€¢ " + item.spotName : ""}</span>
            <div style="margin-top:6px;font-weight:600;">${core.formatPrice(item.price, item.currency)}</div>
          </div>
        </div>
      `).join("");
    }

    function renderThumb(item) {
      if (item.photos && item.photos.length) {
        return `<img src="${item.photos[0]}" alt="" style="width:100%;height:140px;object-fit:cover;border-radius:12px;">`;
      }
      return `<div style="width:100%;height:140px;border-radius:12px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-size:32px;opacity:0.6;">ğŸ›¼</div>`;
    }

    if (els.filterBar) {
      els.filterBar.querySelectorAll(".market-chip").forEach(chip => {
        const key = chip.getAttribute("data-filter");
        chip.onclick = () => {
          if (activeFilters.has(key)) {
            activeFilters.delete(key);
            chip.classList.remove("active");
          } else {
            activeFilters.add(key);
            chip.classList.add("active");
          }
          applyFilters();
        };
      });
    }

    els.searchInput.onkeydown = e => { if (e.key === "Enter") applyFilters(); };
    els.sortSelect.onchange = applyFilters;

    applyFilters();
  });
</script>

</body>
</html>
