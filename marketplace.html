<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Marketplace — Roll ’n Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="rc_global.css">
</head>

<body>

  <!-- OPTIONAL STARFIELD -->
  <div class="stars1"></div>
  <div class="stars2"></div>
  <div class="stars3"></div>

  <div class="rc-app">

    <!-- SIDEBAR -->
    <aside class="rc-sidebar">
      <div class="rc-logo">Roll ’n Connect</div>

      <nav class="rc-nav">
        <button onclick="location.href='dashboard.html'">Dashboard</button>
        <button onclick="location.href='events.html'">Events</button>
        <button onclick="location.href='find-spots.html'">Find Spots</button>
        <button onclick="location.href='chatrooms.html'">Chatrooms</button>
        <button onclick="location.href='profile.html'">Your Profile</button>
        <button onclick="location.href='profile-edit.html'">Edit Profile</button>
        <button class="rc-active">Marketplace</button>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="rc-content">

      <section class="rc-section rc-active" id="marketSection">

        <!-- HEADER + PROFILE SNAPSHOT -->
        <div class="rc-card">
          <div style="display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;align-items:center;">
            <div>
              <h2>Marketplace</h2>
              <p class="rc-muted">Browse, filter, and explore listings from the Roll ’n Connect community.</p>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              <div class="profile-avatar" style="width:44px;height:44px;">
                <img id="profileAvatarMini" alt="Profile avatar">
              </div>
              <div>
                <div id="profileNameMini" style="font-size:14px;font-weight:600;"></div>
                <div id="profileUsernameMini" class="rc-muted" style="font-size:12px;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- SEARCH + FILTERS -->
        <div class="rc-card">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
            <input id="searchInput" class="rc-field-input" placeholder="Search items…" style="flex:1;min-width:180px;">
            <select id="disciplineFilter" class="rc-field-input" style="max-width:200px;">
              <option value="">All Disciplines</option>
              <option value="dance">Dance</option>
              <option value="jam">Jam</option>
              <option value="aggressive">Aggressive</option>
              <option value="speed">Speed</option>
              <option value="artistic">Artistic</option>
            </select>
          </div>
        </div>

        <!-- MARKET GRID -->
        <div class="rc-card">
          <div id="marketGrid" class="rc-market-grid"></div>
        </div>

      </section>

    </main>

  </div>

  <script src="rc_core.js"></script>

  <script>
    // -------- SAFETY: FALLBACK MARKETPLACE DATA (if RC.getMarketplaceItems is missing) --------
    if (typeof RC.getMarketplaceItems !== "function") {
      RC.getMarketplaceItems = function () {
        return [
          {
            id: RC.uuid(),
            title: "Beginner Jam Session Pack",
            discipline: "jam",
            price: 25,
            donateToGiveaway: false,
            imageDataUrl: ""
          },
          {
            id: RC.uuid(),
            title: "Aggressive Rail Basics",
            discipline: "aggressive",
            price: 40,
            donateToGiveaway: true,
            imageDataUrl: ""
          },
          {
            id: RC.uuid(),
            title: "Artistic Flow Routine",
            discipline: "artistic",
            price: 30,
            donateToGiveaway: false,
            imageDataUrl: ""
          }
        ];
      };
    }

    // -------- PROFILE SNAPSHOT --------
    function renderProfileMini() {
      const p = RC.getProfile ? RC.getProfile() || {} : {};
      const nameEl = document.getElementById("profileNameMini");
      const userEl = document.getElementById("profileUsernameMini");
      const avatarEl = document.getElementById("profileAvatarMini");

      nameEl.textContent = p.name || "Unnamed Skater";
      userEl.textContent = p.username ? "@" + p.username : "@unknown";

      if (p.avatarUrl) {
        avatarEl.src = p.avatarUrl;
      } else {
        avatarEl.src = "https://via.placeholder.com/80x80?text=Skater";
      }
    }

    // -------- MARKETPLACE RENDER --------
    function renderMarketplace() {
      const items = RC.getMarketplaceItems() || [];
      const grid = document.getElementById("marketGrid");
      const search = document.getElementById("searchInput").value.toLowerCase();
      const filter = document.getElementById("disciplineFilter").value;

      const filtered = items.filter(i => {
        const title = (i.title || "").toLowerCase();
        const discipline = (i.discipline || "").toLowerCase();

        const matchesSearch =
          title.includes(search) ||
          discipline.includes(search);

        const matchesFilter = filter ? discipline === filter.toLowerCase() : true;

        return matchesSearch && matchesFilter;
      });

      if (!filtered.length) {
        grid.innerHTML = "<p class='rc-muted'>No items found. Try adjusting your search or filters.</p>";
        return;
      }

      grid.innerHTML = filtered.map(item => `
        <div class="rc-market-item">
          <div style="width:100%;height:160px;border-radius:12px;overflow:hidden;background:rgba(255,255,255,0.06);margin-bottom:10px;">
            ${item.imageDataUrl ? `<img src="${item.imageDataUrl}" style="width:100%;height:100%;object-fit:cover;">` : ""}
          </div>
          <div class="rc-market-item-title">${item.title || "Untitled Item"}</div>
          <div class="rc-muted">${item.discipline || "Unlabeled"}</div>
          <div class="rc-market-item-price">$${item.price || 0}</div>
          ${item.donateToGiveaway ? `<div class="rc-chip">Donated to Giveaway</div>` : ""}
          <button class="rc-btn" style="margin-top:10px;"
            onclick="location.href='marketplace-item.html?id=${encodeURIComponent(item.id)}'">
            View Details
          </button>
        </div>
      `).join("");
    }

    // -------- EVENTS --------
    document.getElementById("searchInput").addEventListener("input", renderMarketplace);
    document.getElementById("disciplineFilter").addEventListener("change", renderMarketplace);

    // INIT
    renderProfileMini();
    renderMarketplace();
  </script>

</body>
</html>
